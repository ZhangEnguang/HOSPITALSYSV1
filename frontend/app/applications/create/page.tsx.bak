"use client"

import type React from "react"

import { useState, useEffect } from "react"
import { useRouter, useSearchParams } from "next/navigation"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Label } from "@/components/ui/label"
import { Calendar } from "@/components/ui/calendar"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { ArrowLeft, Plus, Trash2, Upload } from "lucide-react"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import { cn } from "@/lib/utils"
import { format } from "date-fns"
import { CalendarIcon } from "lucide-react"

// æ¨¡æ¿æ•°æ®
const templateData = [
  {
    id: "nsfc",
    name: "å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘å¹´åº¦ç”³æŠ¥",
    title: "2025å¹´åº¦å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘é¡¹ç›®",
    icon: "ğŸ”¬",
    category: "å›½å®¶çº§",
    duration: "æ¯å¹´3æœˆ1æ—¥-3æœˆ20æ—¥",
    description: "å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘å§”å‘˜ä¼šå¹´åº¦å¸¸è§„é¡¹ç›®ç”³æŠ¥",
    tags: ["é¢ä¸Šé¡¹ç›®", "é’å¹´é¡¹ç›®", "é‡ç‚¹é¡¹ç›®", "å½¢å¼å®¡æŸ¥", "é™é¡¹ç®¡ç†"],
    details: {
      cycle: "æ¯å¹´3æœˆ1æ—¥-3æœˆ20æ—¥ï¼ˆç³»ç»Ÿè‡ªåŠ¨æŒ‰å¹´åº¦+1æ›´æ–°ï¼‰",
      fundingScope: ["é¢ä¸Šé¡¹ç›®ï¼š60-100ä¸‡å…ƒ", "é’å¹´é¡¹ç›®ï¼š20-30ä¸‡å…ƒ", "é‡ç‚¹é¡¹ç›®ï¼š300-500ä¸‡å…ƒ"],
      materials: ["ç”³è¯·ä¹¦ï¼ˆæ¨¡æ¿è‡ªåŠ¨æŒ‚æ¥æœ€æ–°ç‰ˆï¼‰", "ç”³è¯·äººç®€å†ï¼ˆåœ¨çº¿ç”Ÿæˆï¼‰", "ä¼¦ç†å®¡æŸ¥è¯æ˜ï¼ˆéœ€ä¸Šä¼ ï¼‰"],
      keyDates: ["æ ¡å†…æˆªæ­¢ï¼š3æœˆ10æ—¥ï¼ˆå¯ä¿®æ”¹ï¼‰", "å½¢å¼å®¡æŸ¥ï¼š3æœˆ11-15æ—¥", "æäº¤åŸºé‡‘å§”ï¼š3æœˆ20æ—¥"],
      specialRequirements: ["é™é¡¹è¯´æ˜ï¼šé«˜çº§èŒç§°é™2é¡¹ï¼ˆæ ¹æ®å¹´åº¦æ”¿ç­–è‡ªåŠ¨æ›´æ–°ï¼‰", "åˆä½œå•ä½ç›–ç« ï¼šéœ€æå‰10ä¸ªå·¥ä½œæ—¥ç”³è¯·"],
    },
    defaultValues: {
      name: "2025å¹´åº¦å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘é¡¹ç›®",
      description: "å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘å§”å‘˜ä¼šå¹´åº¦å¸¸è§„é¡¹ç›®ç”³æŠ¥ï¼ŒåŒ…æ‹¬é¢ä¸Šé¡¹ç›®ã€é’å¹´é¡¹ç›®å’Œé‡ç‚¹é¡¹ç›®",
      type: "å›½å®¶çº§",
      category: "è‡ªç„¶ç§‘å­¦",
      startDate: new Date("2025-03-01"),
      endDate: new Date("2025-03-20"),
      amount: 1000,
      autoEnd: "yes",
      canReview: "yes",
      hasQuota: "yes",
      guide:
        "å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘å§”å‘˜ä¼š2025å¹´åº¦é¡¹ç›®ç”³æŠ¥æŒ‡å—ã€‚æœ¬å¹´åº¦é‡ç‚¹æ”¯æŒåŸºç¡€ç ”ç©¶å’Œå‰æ²¿æ¢ç´¢ï¼Œé¼“åŠ±åŸåˆ›æ€§ç ”ç©¶ã€‚ç”³è¯·äººé¡»ç¬¦åˆå›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘å§”å‘˜ä¼šè§„å®šçš„ç”³è¯·èµ„æ ¼ã€‚",
      template: "è¯·æŒ‰ç…§å›½å®¶è‡ªç„¶ç§‘å­¦åŸºé‡‘å§”å‘˜ä¼šæœ€æ–°å‘å¸ƒçš„ç”³è¯·ä¹¦æ¨¡æ¿å¡«å†™ï¼Œæ³¨æ„éµå¾ªå­—æ•°é™åˆ¶æ ¼å¼è¦æ±‚ã€‚",
      materials: [
        { id: "m1", name: "ç”³è¯·ä¹¦", description: "æ¨¡æ¿è‡ªåŠ¨æŒ‚æ¥æœ€æ–°ç‰ˆ" },
        { id: "m2", name: "ç”³è¯·äººç®€å†", description: "åœ¨çº¿ç”Ÿæˆ" },
        { id: "m3", name: "ä¼¦ç†å®¡æŸ¥è¯æ˜", description: "éœ€ä¸Šä¼ " },
      ],
      keyDates: [
        { id: "d1", name: "æ ¡å†…æˆªæ­¢", date: new Date("2025-03-10") },
        { id: "d2", name: "å½¢å¼å®¡æŸ¥", date: new Date("2025-03-15") },
        { id: "d3", name: "æäº¤åŸºé‡‘å§”", date: new Date("2025-03-20") },
      ],
      requirements: [
        { id: "r1", content: "é™é¡¹è¯´æ˜ï¼šé«˜çº§èŒç§°é™2é¡¹ï¼ˆæ ¹æ®å¹´åº¦æ”¿ç­–è‡ªåŠ¨æ›´æ–°ï¼‰" },
        { id: "r2", content: "åˆä½œå•ä½ç›–ç« ï¼šéœ€æå‰10ä¸ªå·¥ä½œæ—¥ç”³è¯·" },
      ],
      notes: "æœ¬æ‰¹æ¬¡ç”³æŠ¥å°†ç”±ç§‘ç ”å¤„ç»Ÿä¸€ç»„ç»‡å½¢å¼å®¡æŸ¥ï¼Œè¯·å„ç”³è¯·äººåŠ¡å¿…åœ¨æ ¡å†…æˆªæ­¢æ—¥æœŸå‰æäº¤ã€‚",
    },
  },
  {
    id: "provincial-rd",
    name: "çœçº§é‡ç‚¹ç ”å‘è®¡åˆ’ç”³æŠ¥",
    title: "2025Q2æµ™æ±Ÿçœé‡ç‚¹ç ”å‘è®¡åˆ’",
    icon: "ğŸ¢",
    category: "çœéƒ¨çº§",
    duration: "æ¯å­£åº¦é¦–æœˆ1æ—¥-10æ—¥",
    description: "çœç§‘æŠ€å…å­£åº¦é‡ç‚¹ç ”å‘è®¡åˆ’é¡¹ç›®ç”³æŠ¥",
    tags: ["äººå·¥æ™ºèƒ½", "ç”Ÿç‰©åŒ»è¯", "æ–°ææ–™", "é¢„è¯„å®¡", "é™é¢æ¨è"],
    details: {
      cycle: "æ¯å­£åº¦é¦–æœˆ1æ—¥-10æ—¥ï¼ˆä¾‹ï¼šQ2ä¸º4æœˆ1æ—¥-10æ—¥ï¼‰",
      fundingScope: ["äººå·¥æ™ºèƒ½ï¼š200-500ä¸‡å…ƒ", "ç”Ÿç‰©åŒ»è¯ï¼š100-300ä¸‡å…ƒ", "æ–°ææ–™ï¼š150-400ä¸‡å…ƒ"],
      materials: ["å¯è¡Œæ€§æŠ¥å‘Šï¼ˆçœç§‘æŠ€å…æ¨¡æ¿ï¼‰", "é¢„ç®—ä¹¦ï¼ˆè´¢åŠ¡å¤„é¢„å®¡ï¼‰", "è”åˆç”³æŠ¥åè®®ï¼ˆè‡ªåŠ¨ç”ŸæˆèŒƒæœ¬ï¼‰"],
      processRules: ["æ ¡å†…é¢„è¯„å®¡ï¼šå­£åº¦é¦–æœˆ5æ—¥å‰ï¼ˆå¯è°ƒæ•´ï¼‰", "é™é¢æ¨èï¼šæ¯ä¸ªå­¦é™¢é™æŠ¥3é¡¹", "å…¬ç¤ºè¦æ±‚ï¼šæ ¡å†…å…¬ç¤ºè‡³å°‘3å¤©"],
    },
    defaultValues: {
      name: "2025Q2æµ™æ±Ÿçœé‡ç‚¹ç ”å‘è®¡åˆ’",
      description: "æµ™æ±Ÿçœç§‘æŠ€å…å­£åº¦é‡ç‚¹ç ”å‘è®¡åˆ’é¡¹ç›®ç”³æŠ¥ï¼Œé‡ç‚¹æ”¯æŒäººå·¥æ™ºèƒ½ã€ç”Ÿç‰©åŒ»è¯å’Œæ–°ææ–™é¢†åŸŸ",
      type: "çœéƒ¨çº§",
      category: "å·¥ç¨‹æŠ€æœ¯",
      startDate: new Date("2025-04-01"),
      endDate: new Date("2025-04-10"),
      amount: 800,
      autoEnd: "yes",
      canReview: "yes",
      hasQuota: "yes",
      guide:
        "æµ™æ±Ÿçœç§‘æŠ€å…2025å¹´ç¬¬äºŒå­£åº¦é‡ç‚¹ç ”å‘è®¡åˆ’é¡¹ç›®ç”³æŠ¥æŒ‡å—ã€‚æœ¬å­£åº¦é‡ç‚¹æ”¯æŒäººå·¥æ™ºèƒ½ã€ç”Ÿç‰©åŒ»è¯å’Œæ–°æï¿½ï¿½ï¿½é¢†åŸŸçš„åº”ç”¨ç ”ç©¶å’ŒæŠ€æœ¯å¼€å‘ã€‚",
      template: "è¯·æŒ‰ç…§çœç§‘æŠ€å…æä¾›çš„å¯è¡Œæ€§æŠ¥å‘Šæ¨¡æ¿å¡«å†™ï¼Œé‡ç‚¹é˜è¿°é¡¹ç›®çš„åˆ›æ–°æ€§ã€å¯è¡Œæ€§å’Œé¢„æœŸæˆæœã€‚",
      materials: [
        { id: "m1", name: "å¯è¡Œæ€§æŠ¥å‘Š", description: "çœç§‘æŠ€å…æ¨¡æ¿" },
        { id: "m2", name: "é¢„ç®—ä¹¦", description: "è´¢åŠ¡å¤„é¢„å®¡" },
        { id: "m3", name: "è”åˆç”³æŠ¥åè®®", description: "è‡ªåŠ¨ç”ŸæˆèŒƒæœ¬" },
      ],
      keyDates: [
        { id: "d1", name: "æ ¡å†…é¢„è¯„å®¡", date: new Date("2025-04-05") },
        { id: "d2", name: "æ ¡å†…å…¬ç¤º", date: new Date("2025-04-07") },
        { id: "d3", name: "æäº¤çœç§‘æŠ€å…", date: new Date("2025-04-10") },
      ],
      requirements: [
        { id: "r1", content: "é™é¢æ¨èï¼šæ¯ä¸ªå­¦é™¢é™æŠ¥3é¡¹" },
        { id: "r2", content: "å…¬ç¤ºè¦æ±‚ï¼šæ ¡å†…å…¬ç¤ºè‡³å°‘3å¤©" },
      ],
      notes: "æœ¬æ‰¹æ¬¡ç”³æŠ¥é‡‡ç”¨é™é¢æ¨èæ–¹å¼ï¼Œè¯·å„å­¦é™¢åšå¥½é¡¹ç›®é´é€‰å·¥ä½œã€‚",
    },
  },
  {
    id: "university-youth",
    name: "æ ¡çº§é’å¹´åŸºé‡‘ç”³æŠ¥",
    title: "2025å¹´åº¦XXå¤§å­¦é’å¹´ç§‘ç ”å¯åŠ¨åŸºé‡‘",
    icon: "ğŸ“",
    category: "æ ¡çº§",
    duration: "æ¯å¹´9æœˆ1æ—¥-9æœˆ30æ—¥",
    description: "é¢å‘é’å¹´æ•™å¸ˆçš„æ ¡çº§ç§‘ç ”å¯åŠ¨èµ„é‡‘",
    tags: ["é’å¹´æ•™å¸ˆ", "å¯åŠ¨èµ„é‡‘", "æ–°å…¥èŒ", "ä¸“å®¶è¯„å®¡"],
    details: {
      cycle: "æ¯å¹´9æœˆ1æ—¥-9æœˆ30æ—¥",
      fundingTarget: ["å¹´é¾„â‰¤35å²", "æ–°å…¥èŒ3å¹´å†…æ•™å¸ˆ"],
      fundingAmount: ["ç†å·¥ç§‘ï¼š10-20ä¸‡å…ƒ", "æ–‡ç§‘ï¼š5-10ä¸‡å…ƒ"],
      materials: ["ç ”ç©¶è®¡åˆ’ä¹¦ï¼ˆæ ¡çº§æ¨¡æ¿ï¼‰", "å¯¼å¸ˆæ¨èä¿¡ï¼ˆä»…é™åšå£«åï¼‰", "èŒç§°è¯æ˜ï¼ˆäººäº‹å¤„è‡ªåŠ¨æ ¸éªŒï¼‰"],
      reviewProcess: ["å½¢å¼å®¡æŸ¥ï¼š10æœˆ1-7æ—¥", "ä¸“å®¶è¯„å®¡ï¼š10æœˆ8-20æ—¥", "ç»“æœå…¬ç¤ºï¼š10æœˆ25æ—¥"],
    },
    defaultValues: {
      name: "2025å¹´åº¦XXå¤§å­¦é’å¹´ç§‘ç ”å¯åŠ¨åŸºé‡‘",
      description: "é¢å‘é’å¹´æ•™å¸ˆçš„æ ¡çº§ç§‘ç ”å¯åŠ¨èµ„é‡‘ï¼Œæ”¯æŒæ–°å…¥èŒæ•™å¸ˆå¼€å±•ç§‘ç ”å·¥ä½œ",
      type: "æ ¡çº§",
      category: "ç»¼åˆ",
      startDate: new Date("2025-09-01"),
      endDate: new Date("2025-09-30"),
      amount: 200,
      autoEnd: "yes",
      canReview: "no",
      hasQuota: "no",
      guide:
        "XXå¤§å­¦2025å¹´åº¦é’å¹´ç§‘ç ”å¯åŠ¨åŸºé‡‘ç”³æŠ¥æŒ‡å—ã€‚æœ¬åŸºé‡‘é¢å‘å¹´é¾„ä¸è¶…è¿‡35å²æˆ–æ–°å…¥èŒ3å¹´å†…çš„é’å¹´æ•™å¸ˆï¼Œæ—¨åœ¨æ”¯æŒé’å¹´æ•™å¸ˆå¼€å±•åˆ›æ–°æ€§ç§‘ç ”å·¥ä½œã€‚",
      template: "è¯·æŒ‰ç…§å­¦æ ¡ç§‘ç ”å¤„æä¾›çš„ç ”ç©¶è®¡åˆ’ä¹¦æ¨¡æ¿å¡«å†™ï¼Œé‡ç‚¹é˜è¿°ç ”ç©¶æ€è·¯ã€åˆ›æ–°ç‚¹å’Œé¢„æœŸæˆæœã€‚",
      materials: [
        { id: "m1", name: "ç ”ç©¶è®¡åˆ’ä¹¦", description: "æ ¡çº§æ¨¡æ¿" },
        { id: "m2", name: "å¯¼å¸ˆæ¨èä¿¡", description: "ä»…é™åšå£«å" },
        { id: "m3", name: "èŒç§°è¯æ˜", description: "äººäº‹å¤„è‡ªåŠ¨æ ¸éªŒ" },
      ],
      keyDates: [
        { id: "d1", name: "å½¢å¼å®¡æŸ¥", date: new Date("2025-10-07") },
        { id: "d2", name: "ä¸“å®¶è¯„å®¡", date: new Date("2025-10-20") },
        { id: "d3", name: "ç»“æœå…¬ç¤º", date: new Date("2025-10-25") },
      ],
      requirements: [
        { id: "r1", content: "å¹´é¾„â‰¤35å²" },
        { id: "r2", content: "æ–°å…¥èŒ3å¹´å†…æ•™å¸ˆ" },
      ],
      notes: "æœ¬åŸºé‡‘æ—¨åœ¨æ”¯æŒé’å¹´æ•™å¸ˆå¼€å±•åˆ›æ–°æ€§ç§‘ç ”å·¥ä½œï¼Œä¼˜å…ˆæ”¯æŒæ–°å…¥èŒæ•™å¸ˆã€‚",
    },
  },
  {
    id: "international",
    name: "å›½é™…åˆä½œä¸“é¡¹ç”³æŠ¥",
    title: "2025å¹´åº¦ä¸­å¾·è”åˆç ”ç©¶è®¡åˆ’",
    icon: "ğŸŒ",
    category: "å›½é™…åˆä½œ",
    duration: "æŒ‡å—å‘å¸ƒå1å‘¨å†…",
    description: "ä¸­å¾·ç§‘æŠ€åˆä½œè”åˆç ”ç©¶é¡¹ç›®",
    tags: ["å›½é™…åˆä½œ", "åŒè¯­ç”³æŠ¥", "ä¼¦ç†å®¡æŸ¥", "å¤–æ–¹åˆä½œ"],
    details: {
      trigger: 'ç§‘æŠ€éƒ¨å‘å¸ƒ"ä¸­å¾·åˆä½œæŒ‡å—"å1å‘¨å†…',
      fundingFocus: ["æ–°èƒ½æºæŠ€æœ¯", "é«˜ç«¯è£…å¤‡åˆ¶é€ "],
      materials: ["ä¸­å¤–åŒæ–¹æ¡ˆï¼ˆä¸­è‹±æ–‡ï¼‰", "å¾·æ–¹åˆä½œæ„å‘ä¹¦", "é¢„ç®—ï¼ˆæ¬§å…ƒ/äººæ°‘å¸åŒç‰ˆæœ¬ï¼‰"],
      specialReminders: ["æ ¡å†…æˆªæ­¢ï¼šæŒ‡å—æˆªæ­¢å‰20å¤©ï¼ˆè‡ªåŠ¨æ¨ç®—ï¼‰", "ä¼¦ç†å®¡æŸ¥ï¼šæ¶‰åŠäººä½“å®éªŒéœ€æå‰2ä¸ªæœˆ"],
    },
    defaultValues: {
      name: "2025å¹´åº¦ä¸­å¾·è”åˆç ”ç©¶è®¡åˆ’",
      description: "ä¸­å¾·ç§‘æŠ€åˆä½œè”åˆç ”ç©¶é¡¹ç›®ï¼Œé‡ç‚¹æ”¯æŒæ–°èƒ½æºæŠ€æœ¯å’Œé«˜ç«¯è£…å¤‡åˆ¶é€ é¢†åŸŸ",
      type: "å›½é™…åˆä½œ",
      category: "å·¥ç¨‹æŠ€æœ¯",
      startDate: new Date("2025-05-01"),
      endDate: new Date("2025-05-30"),
      amount: 500,
      autoEnd: "no",
      canReview: "yes",
      hasQuota: "no",
      guide:
        "ç§‘æŠ€éƒ¨2025å¹´åº¦ä¸­å¾·è”åˆç ”ç©¶è®¡åˆ’ç”³æŠ¥æŒ‡å—ã€‚æœ¬è®¡åˆ’é‡ç‚¹æ”¯æŒä¸­å¾·åŒæ–¹åœ¨æ–°èƒ½æºæŠ€æœ¯å’Œé«˜ç«¯è£…å¤‡åˆ¶é€ é¢†åŸŸçš„è”åˆç ”ç©¶é¡¹ç›®ã€‚",
      template: "è¯·æŒ‰ç…§ç§‘æŠ€éƒ¨è¦æ±‚å‡†å¤‡ä¸­è‹±æ–‡åŒè¯­ç”³è¯·ææ–™ï¼Œå¹¶ç¡®ä¿å¾·æ–¹åˆä½œä¼™ä¼´åŒæ­¥æäº¤å¾·æ–¹ç”³è¯·ã€‚",
      materials: [
        { id: "m1", name: "ä¸­å¤–åŒæ–¹æ¡ˆï¼ˆä¸­è‹±æ–‡ï¼‰", description: "åŒè¯­ç‰ˆæœ¬" },
        { id: "m2", name: "å¾·æ–¹åˆä½œæ„å‘ä¹¦", description: "éœ€å¾·æ–¹ç­¾ç« " },
        { id: "m3", name: "é¢„ç®—ï¼ˆæ¬§å…ƒ/äººæ°‘å¸åŒç‰ˆæœ¬ï¼‰", description: "æŒ‰ç»Ÿä¸€æ±‡ç‡æ¢ç®—" },
      ],
      keyDates: [
        { id: "d1", name: "æ ¡å†…æˆªæ­¢", date: new Date("2025-05-10") },
        { id: "d2", name: "æäº¤ç§‘æŠ€éƒ¨", date: new Date("2025-05-30") },
      ],
      requirements: [
        { id: "r1", content: "ä¼¦ç†å®¡æŸ¥ï¼šæ¶‰åŠäººä½“å®éªŒéœ€æå‰2ä¸ªæœˆ" },
        { id: "r2", content: "éœ€æä¾›å¤–æ–¹åˆä½œè¯æ˜ææ–™" },
      ],
      notes: "æœ¬æ‰¹æ¬¡ç”³æŠ¥éœ€ä¸­å¾·åŒæ–¹åŒæ­¥æäº¤ç”³è¯·ï¼Œè¯·ç¡®ä¿ä¸å¾·æ–¹åˆä½œä¼™ä¼´ä¿æŒè‰¯å¥½æ²Ÿé€šã€‚",
    },
  },
]

// ç±»å‹å®šä¹‰
type Material = {
  id: string
  name: string
  description: string
}

type KeyDate = {
  id: string
  name: string
  date: Date
}

type Requirement = {
  id: string
  content: string
}

type FormData = {
  name: string
  description: string
  type: string
  category: string
  startDate: Date
  endDate: Date
  amount: number
  autoEnd: string
  canReview: string
  hasQuota: string
  guide: string
  template: string
  materials: Material[]
  keyDates: KeyDate[]
  requirements: Requirement[]
  notes: string
}

type Attachment = {
  id: string
  name: string
  size: number
  type: string
}

export default function CreateApplicationPage() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const templateId = searchParams.get("template")

  // é»˜è®¤è¡¨å•æ•°æ®
  const defaultFormData: FormData = {
    name: "",
    description: "",
    type: "",
    category: "",
    startDate: new Date(),
    endDate: new Date(new Date().setMonth(new Date().getMonth() + 1)),
    amount: 0,
    autoEnd: "no",
    canReview: "no",
    hasQuota: "no",
    guide: "",
    template: "",
    materials: [{ id: "default-1", name: "", description: "" }],
    keyDates: [{ id: "default-1", name: "", date: new Date() }],
    requirements: [{ id: "default-1", content: "" }],
    notes: "",
  }

  // åˆå§‹åŒ–è¡¨å•æ•°æ®
  const getInitialFormData = () => {
    if (templateId) {
      const template = templateData.find((t) => t.id === templateId)
      if (template && template.defaultValues) {
        return {
          ...template.defaultValues,
          startDate: new Date(template.defaultValues.startDate),
          endDate: new Date(template.defaultValues.endDate),
          keyDates: template.defaultValues.keyDates.map((date) => ({
            ...date,
            date: new Date(date.date),
          })),
        }
      }
    }
    return defaultFormData
  }

  const [formData, setFormData] = useState<FormData>(getInitialFormData())
  const [activeTab, setActiveTab] = useState("basic")
  const [attachments, setAttachments] = useState<Attachment[]>([])
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [isLoaded, setIsLoaded] = useState(false)

  // åŠ è½½æ¨¡æ¿æ•°æ®
  useEffect(() => {
    if (templateId && !isLoaded) {
      const template = templateData.find((t) => t.id === templateId)
      if (template && template.defaultValues) {
        const newFormData = {
          ...template.defaultValues,
          startDate: new Date(template.defaultValues.startDate),
          endDate: new Date(template.defaultValues.endDate),
          keyDates: template.defaultValues.keyDates.map((date) => ({
            ...date,
            date: new Date(date.date),
          })),
        }
        setFormData(newFormData)
        setIsLoaded(true)
        console.log("å·²åŠ è½½æ¨¡æ¿æ•°æ®:", template.name)
      }
    }
  }, [templateId, isLoaded])

  // å¤„ç†å‡½æ•°
  const handleAddMaterial = () => {
    const newId = `material-${Date.now()}`
    setFormData({
      ...formData,
      materials: [...formData.materials, { id: newId, name: "", description: "" }],
    })
  }

  const handleRemoveMaterial = (id: string) => {
    setFormData({
      ...formData,
      materials: formData.materials.filter((item) => item.id !== id),
    })
  }

  const handleUpdateMaterial = (id: string, field: keyof Material, value: string) => {
    setFormData({
      ...formData,
      materials: formData.materials.map((item) => (item.id === id ? { ...item, [field]: value } : item)),
    })
  }

  const handleAddKeyDate = () => {
    const newId = `date-${Date.now()}`
    setFormData({
      ...formData,
      keyDates: [...formData.keyDates, { id: newId, name: "", date: new Date() }],
    })
  }

  const handleRemoveKeyDate = (id: string) => {
    setFormData({
      ...formData,
      keyDates: formData.keyDates.filter((item) => item.id !== id),
    })
  }

  const handleUpdateKeyDate = (id: string, field: keyof KeyDate, value: any) => {
    setFormData({
      ...formData,
      keyDates: formData.keyDates.map((item) => (item.id === id ? { ...item, [field]: value } : item)),
    })
  }

  const handleAddRequirement = () => {
    const newId = `req-${Date.now()}`
    setFormData({
      ...formData,
      requirements: [...formData.requirements, { id: newId, content: "" }],
    })
  }

  const handleRemoveRequirement = (id: string) => {
    setFormData({
      ...formData,
      requirements: formData.requirements.filter((item) => item.id !== id),
    })
  }

  const handleUpdateRequirement = (id: string, content: string) => {
    setFormData({
      ...formData,
      requirements: formData.requirements.map((item) => (item.id === id ? { ...item, content } : item)),
    })
  }

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files
    if (!files) return

    const newAttachments: Attachment[] = []

    for (let i = 0; i < files.length; i++) {
      const file = files[i]
      if (attachments.length + newAttachments.length >= 10) break

      newAttachments.push({
        id: `file-${Date.now()}-${i}`,
        name: file.name,
        size: file.size,
        type: file.type,
      })
    }

    setAttachments([...attachments, ...newAttachments])
  }

  const handleRemoveAttachment = (id: string) => {
    setAttachments(attachments.filter((item) => item.id !== id))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSubmitting(true)

    // æ¨¡æ‹Ÿæäº¤
    await new Promise((resolve) => setTimeout(resolve, 1000))

    // æäº¤æˆåŠŸåè¿”å›åˆ—è¡¨é¡µ
    router.push("/applications")
  }

  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  const formatFileSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes} B`
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
  }

  return (
    <div className="container py-6 max-w-5xl">
      {process.env.NODE_ENV === "development" && templateId && false && (
        <div className="bg-muted p-2 mb-4 rounded text-sm">
          <p>å½“å‰æ¨¡æ¿ID: {templateId}</p>
          <p>æ¨¡æ¿åç§°: {templateData.find((t) => t.id === templateId)?.name || "æœªæ‰¾åˆ°"}</p>
          <p>è¡¨å•åç§°: {formData.name || "æœªè®¾ç½®"}</p>
        </div>
      )}

      <div className="flex items-center gap-2 mb-6">
        <Button variant="ghost" size="icon" onClick={() => router.back()}>
          <ArrowLeft className="h-4 w-4" />
        </Button>
        <h1 className="text-2xl font-bold">åˆ›å»ºç”³æŠ¥æ‰¹æ¬¡</h1>
        {templateId && (
          <Badge variant="outline" className="ml-2">
            ä½¿ç”¨æ¨¡æ¿: {templateData.find((t) => t.id === templateId)?.name}
          </Badge>
        )}
      </div>

      <form onSubmit={handleSubmit}>
        <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="basic">åŸºæœ¬ä¿¡æ¯</TabsTrigger>
            <TabsTrigger value="materials">ç”³æŠ¥ææ–™</TabsTrigger>
            <TabsTrigger value="dates">æ—¶é—´èŠ‚ç‚¹</TabsTrigger>
            <TabsTrigger value="requirements">ç‰¹æ®Šè¦æ±‚</TabsTrigger>
          </TabsList>

          {/* åŸºæœ¬ä¿¡æ¯é€‰é¡¹å¡ */}
          <TabsContent value="basic" className="space-y-6 mt-6">
            <Card>
              <CardHeader>
                <CardTitle>åŸºæœ¬ä¿¡æ¯</CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2 md:col-span-2">
                    <Label htmlFor="name" className="flex items-center">
                      ç”³è¯·è®¡åˆ’åç§° <span className="text-red-500 ml-1">*</span>
                    </Label>
                    <Input
                      id="name"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      placeholder="è¯·è¾“å…¥ç”³è¯·è®¡åˆ’åç§°"
                      required
                    />
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="startDate" className="flex items-center">
                      ç”³è¯·å¼€å§‹æ—¥æœŸ <span className="text-red-500 ml-1">*</span>
                    </Label>
                    <Popover>
                      <PopoverTrigger asChild>
                        <Button
                          variant="outline"
                          className={cn(
                            "w-full justify-start text-left font-normal",
                            !formData.startDate && "text-muted-foreground",
                          )}
                        >
                          <CalendarIcon className="mr-2 h-4 w-4" />
                          {formData.startDate ? format(formData.startDate, "PPP") : <span>é€‰æ‹©æ—¥æœŸ</span>}
                        </Button>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0">
                        <Calendar
                          mode="single"
                          selected={formData.startDate}
                          onSelect={(date) => date && setFormData({ ...formData, startDate: date })}
                          initialFocus
                        />
                      </PopoverContent>
                    </Popover>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="endDate" className="flex items-center">
                      ç”³è¯·ç»“æŸæ—¥æœŸ <span className="text-red-500 ml-1">*</span>
                    </Label>
                    <Popover>
                      <PopoverTrigger asChild>
                        <Button
                          variant="outline"
                          className={cn(
                            "w-full justify-start text-left font-normal",
                            !formData.endDate && "text-muted-foreground",
                          )}
                        >
                          <CalendarIcon className="mr-2 h-4 w-4" />
                          {formData.endDate ? format(formData.endDate, "PPP") : <span>é€‰æ‹©æ—¥æœŸ</span>}
                        </Button>
                      </PopoverTrigger>
                      <PopoverContent className="w-auto p-0">
                        <Calendar
                          mode="single"
                          selected={formData.endDate}
                          onSelect={(date) => date && setFormData({ ...formData, endDate: date })}
                          initialFocus
                        />
                      </PopoverContent>
                    </Popover>
                  </div>

                  <div className="space-y-2">
                    <Label className="flex items-center">åˆ°æœŸè‡ªåŠ¨ç»“æŸ</Label>
                    <RadioGroup
                      value={formData.autoEnd}
                      onValueChange={(value) => setFormData({ ...formData, autoEnd: value })}
                      className="flex space-x-4"
                    >
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="yes" id="auto-end-yes" />
                        <Label htmlFor="auto-end-yes">æ˜¯</Label>
                      </div>
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="no" id="auto-end-no" />
                        <Label htmlFor="auto-end-no">å¦</Label>
                      </div>
                    </RadioGroup>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="category" className="flex items-center">
                      é¡¹ç›®åˆ†ç±» <span className="text-red-500 ml-1">*</span>
                    </Label>
                    <Select
                      value={formData.category}
                      onValueChange={(value) => setFormData({ ...formData, category: value })}
                      required
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="è¯·é€‰æ‹©é¡¹ç›®åˆ†ç±»" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="è‡ªç„¶ç§‘å­¦">è‡ªç„¶ç§‘å­¦</SelectItem>
                        <SelectItem value="å·¥ç¨‹æŠ€æœ¯">å·¥ç¨‹æŠ€æœ¯</SelectItem>
                        <SelectItem value="å†œä¸šç§‘å­¦">å†œä¸šç§‘å­¦</SelectItem>
                        <SelectItem value="åŒ»è¯ç§‘å­¦">åŒ»è¯ç§‘å­¦</SelectItem>
                        <SelectItem value="äººæ–‡ç¤¾ç§‘">äººæ–‡ç¤¾ç§‘</SelectItem>
                        <SelectItem value="æ•™è‚²ç§‘å­¦">æ•™è‚²ç§‘å­¦</SelectItem>
                        <SelectItem value="ç»¼åˆ">ç»¼åˆ</SelectItem>
                        <SelectItem value="å…¶ä»–">å…¶ä»–</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label className="flex items-center">æ˜¯å¦å¯è½¬å…¥è¯„å®¡</Label>
                    <RadioGroup
                      value={formData.canReview}
                      onValueChange={(value) => setFormData({ ...formData, canReview: value })}
                      className="flex space-x-4"
                    >
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="yes" id="can-review-yes" />
                        <Label htmlFor="can-review-yes">æ˜¯</Label>
                      </div>
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="no" id="can-review-no" />
                        <Label htmlFor="can-review-no">å¦</Label>
                      </div>
                    </RadioGroup>
                  </div>

                  <div className="space-y-2">
                    <Label className="flex items-center">æ˜¯å¦å•ä½é™é¢</Label>
                    <RadioGroup
                      value={formData.hasQuota}
                      onValueChange={(value) => setFormData({ ...formData, hasQuota: value })}
                      className="flex space-x-4"
                    >
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="yes" id="has-quota-yes" />
                        <Label htmlFor="has-quota-yes">æ˜¯</Label>
                      </div>
                      <div className="flex items-center space-x-2">
                        <RadioGroupItem value="no" id="has-quota-no" />
                        <Label htmlFor="has-quota-no">å¦</Label>
                      </div>
                    </RadioGroup>
                  </div>
                </div>

                <Separator />

                <div className="space-y-2">
                  <Label htmlFor="guide" className="flex items-center">
                    ç”³è¯·æŒ‡å— <span className="text-red-500 ml-1">*</span>
                  </Label>
                  <Textarea
                    id="guide"
                    value={formData.guide}
                    onChange={(e) => setFormData({ ...formData, guide: e.target.value })}
                    placeholder="è¯·è¾“å…¥ç”³è¯·æŒ‡å—å†…å®¹"
                    rows={4}
                    required
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="template">ç”³è¯·ä¹¦æ¨¡æ¿</Label>
                  <Textarea
                    id="template"
                    value={formData.template}
                    onChange={(e) => setFormData({ ...formData, template: e.target.value })}
                    placeholder="è¯·è¾“å…¥ç”³è¯·ä¹¦æ¨¡æ¿å†…å®¹æˆ–ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶"
                    rows={3}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="notes">å¤‡æ³¨</Label>
                  <Textarea
                    id="notes"
                    value={formData.notes}
                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                    placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"
                    rows={3}
                  />
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* ç”³æŠ¥ææ–™é€‰é¡¹å¡ */}
          <TabsContent value="materials" className="space-y-6 mt-6">
            <Card>
              <CardHeader>
                <CardTitle>é™„ä»¶ä¸Šä¼ </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="border-2 border-dashed rounded-lg p-6 text-center">
                  <div className="flex flex-col items-center justify-center space-y-2">
                    <Upload className="h-8 w-8 text-muted-foreground" />
                    <p className="text-sm text-muted-foreground">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                    <p className="text-xs text-muted-foreground">æœ€å¤šå¯ä¸Šä¼ 10ä¸ªé™„ä»¶ï¼Œæ¯ä¸ªé™„ä»¶å¤§å°ä¸è¶…è¿‡20M</p>
                    <Input
                      type="file"
                      className="hidden"
                      id="file-upload"
                      multiple
                      onChange={handleFileUpload}
                      accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar"
                    />
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => document.getElementById("file-upload")?.click()}
                      disabled={attachments.length >= 10}
                    >
                      é€‰æ‹©æ–‡ä»¶
                    </Button>
                  </div>
                </div>

                {attachments.length > 0 && (
                  <div className="space-y-2 mt-4">
                    <h3 className="text-sm font-medium">å·²ä¸Šä¼ æ–‡ä»¶ ({attachments.length}/10)</h3>
                    <div className="space-y-2">
                      {attachments.map((file) => (
                        <div key={file.id} className="flex items-center justify-between p-2 border rounded-md">
                          <div className="flex items-center space-x-2">
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium truncate">{file.name}</p>
                              <p className="text-xs text-muted-foreground">{formatFileSize(file.size)}</p>
                            </div>
                          </div>
                          <Button
                            type="button"
                            variant="ghost"
                            size="sm"
                            onClick={() => handleRemoveAttachment(file.id)}
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>ææ–™æ¸…å•</CardTitle>
                <Button type="button" variant="outline" size="sm" onClick={handleAddMaterial}>
                  <Plus className="h-4 w-4 mr-1" />
                  æ·»åŠ ææ–™
                </Button>
              </CardHeader>
              <CardContent className="space-y-4">
                {formData.materials.map((material) => (
                  <div key={material.id} className="flex items-start space-x-3 p-3 border rounded-md">
                    <div className="flex-1 space-y-3">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div className="space-y-1">
                          <Label htmlFor={`material-name-${material.id}`}>ææ–™åç§°</Label>
                          <Input
                            id={`material-name-${material.id}`}
                            value={material.name}
                            onChange={(e) => handleUpdateMaterial(material.id, "name", e.target.value)}
                            placeholder="ä¾‹å¦‚ï¼šç”³è¯·ä¹¦"
                          />
                        </div>
                        <div className="space-y-1">
                          <Label htmlFor={`material-desc-${material.id}`}>ææ–™è¯´æ˜</Label>
                          <Input
                            id={`material-desc-${material.id}`}
                            value={material.description}
                            onChange={(e) => handleUpdateMaterial(material.id, "description", e.target.value)}
                            placeholder="ä¾‹å¦‚ï¼šæ¨¡æ¿è‡ªåŠ¨æŒ‚æ¥æœ€æ–°ç‰ˆ"
                          />
                        </div>
                      </div>
                    </div>
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => handleRemoveMaterial(material.id)}
                      disabled={formData.materials.length <= 1}
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                ))}
              </CardContent>
            </Card>
          </TabsContent>

          {/* æ—¶é—´èŠ‚ç‚¹é€‰é¡¹å¡ */}
          <TabsContent value="dates" className="space-y-6 mt-6">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>å…³é”®æ—¶é—´èŠ‚ç‚¹</CardTitle>
                <Button type="button" variant="outline" size="sm" onClick={handleAddKeyDate}>
                  <Plus className="h-4 w-4 mr-1" />
                  æ·»åŠ æ—¶é—´èŠ‚ç‚¹
                </Button>
              </CardHeader>
              <CardContent className="space-y-4">
                {formData.keyDates.map((keyDate) => (
                  <div key={keyDate.id} className="flex items-start space-x-3 p-3 border rounded-md">
                    <div className="flex-1 space-y-3">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div className="space-y-1">
                          <Label htmlFor={`keydate-name-${keyDate.id}`}>èŠ‚ç‚¹åç§°</Label>
                          <Input
                            id={`keydate-name-${keyDate.id}`}
                            value={keyDate.name}
                            onChange={(e) => handleUpdateKeyDate(keyDate.id, "name", e.target.value)}
                            placeholder="ä¾‹å¦‚ï¼šæ ¡å†…æˆªæ­¢"
                          />
                        </div>
                        <div className="space-y-1">
                          <Label htmlFor={`keydate-date-${keyDate.id}`}>æ—¥æœŸ</Label>
                          <Popover>
                            <PopoverTrigger asChild>
                              <Button
                                variant="outline"
                                className={cn(
                                  "w-full justify-start text-left font-normal",
                                  !keyDate.date && "text-muted-foreground",
                                )}
                              >
                                <CalendarIcon className="mr-2 h-4 w-4" />
                                {keyDate.date ? format(keyDate.date, "PPP") : <span>é€‰æ‹©æ—¥æœŸ</span>}
                              </Button>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0">
                              <Calendar
                                mode="single"
                                selected={keyDate.date}
                                onSelect={(date) => date && handleUpdateKeyDate(keyDate.id, "date", date)}
                                initialFocus
                              />
                            </PopoverContent>
                          </Popover>
                        </div>
                      </div>
                    </div>
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => handleRemoveKeyDate(keyDate.id)}
                      disabled={formData.keyDates.length <= 1}
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                ))}
              </CardContent>
            </Card>
          </TabsContent>

          {/* ç‰¹æ®Šè¦æ±‚é€‰é¡¹å¡ */}
          <TabsContent value="requirements" className="space-y-6 mt-6">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle>ç‰¹æ®Šè¦æ±‚</CardTitle>
                <Button type="button" variant="outline" size="sm" onClick={handleAddRequirement}>
                  <Plus className="h-4 w-4 mr-1" />
                  æ·»åŠ è¦æ±‚
                </Button>
              </CardHeader>
              <CardContent className="space-y-4">
                {formData.requirements.map((requirement) => (
                  <div key={requirement.id} className="flex items-start space-x-3 p-3 border rounded-md">
                    <div className="flex-1 space-y-1">
                      <Label htmlFor={`requirement-${requirement.id}`}>è¦æ±‚å†…å®¹</Label>
                      <Textarea
                        id={`requirement-${requirement.id}`}
                        value={requirement.content}
                        onChange={(e) => handleUpdateRequirement(requirement.id, e.target.value)}
                        placeholder="ä¾‹å¦‚ï¼šé™é¡¹è¯´æ˜ï¼šé«˜çº§èŒç§°é™2é¡¹"
                        rows={2}
                      />
                    </div>
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => handleRemoveRequirement(requirement.id)}
                      disabled={formData.requirements.length <= 1}
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                ))}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        <div className="flex justify-end gap-4 mt-8">
          {process.env.NODE_ENV === "development" && false && (
            <Button type="button" variant="outline" onClick={() => console.log("å½“å‰è¡¨å•æ•°æ®:", formData)}>
              è°ƒè¯•æ•°æ®
            </Button>
          )}
          <Button variant="outline" type="button" onClick={() => router.back()}>
            å–æ¶ˆ
          </Button>
          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting ? "æäº¤ä¸­..." : "æäº¤"}
          </Button>
        </div>
      </form>
    </div>
  )
}

