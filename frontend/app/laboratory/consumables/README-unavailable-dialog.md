# 耗材不可申领弹框功能

## 功能概述

为耗材管理模块添加了不可申领弹框功能，与试剂管理的不可申领弹框保持完全一致的功能和用户体验。当用户点击不可申领耗材的申领按钮时，系统会智能判断并显示相应的不可申领弹框，提供详细的原因说明和解决方案。

## 核心功能

### 1. 智能判断机制
- **过期检测**：检查耗材是否已过期或状态为"已过期"
- **库存检测**：检查耗材库存是否为零或状态为"缺货"
- **综合判断**：根据过期和库存状态智能决定显示哪个弹框

### 2. 不可申领原因分类
- **已过期且无库存**（最高严重程度）：红色警告
- **仅已过期**（高严重程度）：红色警告
- **仅库存不足**（中等严重程度）：橙色警告
- **其他原因**（低严重程度）：灰色提示

### 3. 详细信息展示
- **耗材基本信息**：名称、英文名、规格、状态
- **库存信息**：当前库存、所属部门、存放位置
- **状态标识**：库存状态、过期状态等可视化标签

### 4. AI智能推荐算法
基于以下维度推荐替代耗材：
- **类别相似性**（40分）：优先推荐同类别耗材
- **用途相似性**（30分）：基于描述关键词匹配
- **规格相似性**（20分）：规格参数匹配度
- **可用性加分**（10分）：库存充足的耗材优先

### 5. 管理员联系功能
- **耗材管理员信息**：姓名、部门、联系方式
- **一键联系**：支持电话和邮件联系
- **预填邮件内容**：自动填充耗材申领咨询主题和内容

### 6. 快速申领功能
- **推荐耗材展示**：显示可申领的替代耗材
- **一键申领**：直接跳转到推荐耗材的申领页面
- **库存状态显示**：实时显示推荐耗材的库存情况

## 技术实现

### 组件结构
```
app/laboratory/consumables/
├── components/
│   └── consumable-unavailable-dialog.tsx  # 不可申领弹框组件
├── page.tsx                               # 耗材页面（已更新）
└── config/
    └── consumable-config.tsx              # 耗材配置（已更新）
```

### 关键代码修改

#### 1. 页面状态管理
```typescript
// 不可申领弹框状态
const [unavailableDialogOpen, setUnavailableDialogOpen] = useState(false)
const [selectedConsumableForUnavailable, setSelectedConsumableForUnavailable] = useState<any>(null)
```

#### 2. 智能申领处理
```typescript
const handleOpenApplyDialog = (consumable: any) => {
  const canApply = () => {
    const today = new Date()
    const expiryDate = new Date(consumable.expiryDate)
    const isExpired = expiryDate < today || consumable.status === "已过期"
    const isOutOfStock = consumable.currentStock <= 0 || consumable.status === "缺货"
    return !isExpired && !isOutOfStock
  }

  if (!canApply()) {
    setSelectedConsumableForUnavailable(consumable)
    setUnavailableDialogOpen(true)
    return
  }

  setSelectedConsumableForApply(consumable)
  setApplyDialogOpen(true)
}
```

#### 3. 操作按钮配置
移除了申领按钮的禁用逻辑，让所有耗材的申领按钮都可以点击，由页面处理函数决定显示哪个弹框。

## 用户体验设计

### 1. 视觉设计
- **一致性**：与试剂管理弹框保持完全一致的设计风格
- **层次感**：通过颜色和图标区分不同严重程度的问题
- **响应式**：支持不同屏幕尺寸的自适应布局

### 2. 交互设计
- **渐进式加载**：推荐耗材采用骨架屏加载效果
- **悬停反馈**：推荐耗材卡片支持悬停高亮效果
- **一键操作**：支持快速申领和联系管理员

### 3. 信息架构
- **左右分栏**：不可申领原因和AI推荐分别展示
- **卡片式布局**：信息分组清晰，易于阅读
- **操作引导**：明确的操作按钮和提示文案

## 使用场景

### 1. 过期耗材处理
- 用户点击已过期耗材的申领按钮
- 系统显示过期警告和处理建议
- 推荐可用的替代耗材
- 提供管理员联系方式

### 2. 缺货耗材申领
- 用户尝试申领无库存耗材
- 系统提示库存不足原因
- AI推荐同类可用耗材
- 支持快速申领替代品

### 3. 紧急需求处理
- 提供管理员直接联系方式
- 预填邮件模板便于快速沟通
- 显示紧急联系提示

## 最佳实践

### 1. 数据一致性
- 确保耗材状态与实际库存同步
- 定期更新有效期信息
- 维护准确的耗材分类数据

### 2. 推荐算法优化
- 根据实际使用情况调整相似性权重
- 定期更新耗材描述和关键词
- 收集用户反馈优化推荐效果

### 3. 用户培训
- 向用户说明不可申领弹框的功能
- 培训管理员及时处理申领请求
- 建立耗材申领流程规范

## 与试剂管理对比

| 功能特性 | 试剂管理 | 耗材管理 | 一致性 |
|---------|---------|---------|--------|
| 智能判断逻辑 | ✅ | ✅ | 完全一致 |
| 不可申领原因分类 | ✅ | ✅ | 完全一致 |
| AI推荐算法 | 化学性质分析 | 用途相似性分析 | 算法适配 |
| 管理员联系 | 试剂管理员 | 耗材管理员 | 角色对应 |
| 快速申领 | ✅ | ✅ | 完全一致 |
| 界面设计 | ✅ | ✅ | 完全一致 |

## 总结

耗材不可申领弹框功能成功实现了与试剂管理的功能对等，提供了完整的不可申领处理流程。通过智能判断、AI推荐和便捷联系等功能，大大提升了用户在处理不可申领耗材时的体验，同时保持了系统的一致性和专业性。 