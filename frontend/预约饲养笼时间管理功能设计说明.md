# 预约饲养笼时间管理功能设计说明

## 功能概述

本功能为动物房预约系统添加了完整的时间管理机制，实现了笼位预约的时间控制、自动释放和状态管理。

## 核心功能

### 1. 时间设置功能
- **开始时间**：用户可以设置笼位使用的开始时间
- **结束时间**：用户可以设置笼位使用的结束时间  
- **自动计算时长**：系统根据开始和结束时间自动计算预约时长
- **时间验证**：确保时间设置的合理性

### 2. 时间验证规则
- 开始时间不能早于当前时间
- 结束时间必须晚于开始时间
- 预约时长不能超过6个月
- 实时验证用户输入的时间范围

### 3. 自动释放机制
- **定时释放**：预约到期后自动释放笼位
- **状态更新**：笼位状态自动从"不可预约"变为"可预约"
- **通知提醒**：释放时显示系统通知
- **定期检查**：每分钟检查一次过期预约

### 4. 预约状态管理
- **预约信息存储**：存储预约人、单位、时间等信息
- **状态显示**：笼位卡片显示预约状态标识
- **悬浮提示**：鼠标悬浮显示详细预约信息
- **统计面板**：实时显示预约统计数据

## 技术实现

### 数据结构设计

```typescript
// 笼位数据接口
interface CageData {
  id: string
  number: number
  status: CageStatus
  notes?: string
  reservationInfo?: {
    applicantName: string
    department: string
    startTime: string
    endTime: string
    reservationId: string
  }
}

// 预约表单数据接口
interface ReservationForm {
  applicantName: string
  department: string
  relatedProject: string
  contactPhone: string
  purpose: string
  notes: string
  startTime: string
  endTime: string
  duration: string
}
```

### 核心功能函数

#### 1. 时间验证函数
```typescript
const validateTimeRange = (startTime: string, endTime: string) => {
  // 验证时间范围的合理性
  // 检查开始时间、结束时间和预约时长
}
```

#### 2. 时长计算函数
```typescript
const calculateDuration = (startTime: string, endTime: string) => {
  // 自动计算预约时长
  // 支持天、周、月的智能显示
}
```

#### 3. 预约管理器
```typescript
const reservationManager = {
  createReservation: (cageIds, reservationData) => {
    // 创建预约并设置自动释放定时器
  },
  releaseReservation: (reservationId) => {
    // 释放预约并更新笼位状态
  },
  checkConflict: (cageIds, startTime, endTime) => {
    // 检查预约时间冲突
  },
  getReservationStats: () => {
    // 获取预约统计信息
  }
}
```

#### 4. 过期检查机制
```typescript
const checkExpiredReservations = () => {
  // 检查并释放过期预约
  // 每分钟自动执行一次
}
```

## UI界面设计

### 1. 时间选择器
- 使用 `datetime-local` 输入类型
- 支持日期和时间的精确选择
- 设置最小值限制（不能早于当前时间）
- 结束时间最小值动态更新

### 2. 时长显示
- 蓝色背景的信息卡片
- 实时显示计算的预约时长
- 支持天、周、月的友好显示格式

### 3. 笼位状态显示
- 已预约笼位显示橙色圆点标识
- 鼠标悬浮显示详细预约信息
- 状态图例包含"已预约"说明

### 4. 统计面板
- 当前预约数量
- 24小时内到期数量
- 可预约数量
- 实时更新统计数据

## 逻辑流程

### 1. 预约创建流程
1. 用户选择笼位
2. 填写预约信息（包括时间）
3. 系统验证时间范围
4. 创建预约记录
5. 更新笼位状态
6. 设置自动释放定时器

### 2. 自动释放流程
1. 定时器到期触发
2. 查找对应预约记录
3. 更新笼位状态为可预约
4. 清除预约信息
5. 显示释放通知

### 3. 状态检查流程
1. 每分钟执行检查
2. 遍历所有预约记录
3. 比较当前时间与结束时间
4. 释放过期预约
5. 更新界面显示

## 用户体验优化

### 1. 智能时间设置
- 开始时间默认限制为当前时间之后
- 结束时间最小值跟随开始时间变化
- 实时计算并显示预约时长

### 2. 直观状态显示
- 橙色圆点标识已预约笼位
- 悬浮提示显示完整预约信息
- 统计面板实时更新数据

### 3. 友好的错误提示
- 时间设置错误时显示具体原因
- 预约时长超限时给出明确提示
- 必填字段验证提示

### 4. 自动化管理
- 无需手动释放过期预约
- 定期检查确保数据准确性
- 释放时自动通知用户

## 扩展功能建议

### 1. 预约提醒
- 预约到期前24小时提醒
- 预约到期前1小时提醒
- 邮件或短信通知功能

### 2. 预约延期
- 支持预约时间延长
- 延期申请审批流程
- 冲突检查和处理

### 3. 预约历史
- 记录所有预约历史
- 支持历史查询和统计
- 生成使用报告

### 4. 批量操作
- 批量设置预约时间
- 批量释放预约
- 批量状态更新

## 安全性考虑

### 1. 数据验证
- 前端和后端双重验证
- 防止恶意时间设置
- 输入格式严格校验

### 2. 权限控制
- 只有授权用户可以预约
- 管理员可以强制释放预约
- 操作日志记录

### 3. 数据一致性
- 预约状态同步更新
- 避免并发操作冲突
- 数据备份和恢复

## 性能优化

### 1. 定时器管理
- 合理设置检查频率
- 避免过多定时器创建
- 内存泄漏预防

### 2. 状态更新
- 批量状态更新
- 减少不必要的重新渲染
- 优化数据结构

### 3. 用户界面
- 懒加载和虚拟滚动
- 防抖和节流处理
- 缓存常用数据

## 总结

本功能实现了完整的预约时间管理机制，包括时间设置、验证、自动释放和状态管理。通过合理的数据结构设计和用户界面优化，提供了良好的用户体验和系统稳定性。功能具有良好的扩展性，可以根据实际需求进行进一步的功能增强。 